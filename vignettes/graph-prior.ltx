%\VignetteIndexEntry{Understand graph prior ramifications}
%\VignetteEngine{R.rsp::tex}

\documentclass{article}
\usepackage[margin=2cm]{geometry}

\usepackage{amsmath}
\usepackage{booktabs} % For table
\usepackage{mathrsfs}
\usepackage{mathtools}
\usepackage{parskip}
\usepackage{bm}
\usepackage{xfrac} % supercedes nicefrac
\usepackage{amsfonts}
\usepackage{setspace}
\usepackage{xr}
\usepackage{pv3rs} % For notation
\usepackage{subcaption} % For subfigure
\usepackage{sidecap} % For side captions


\newcommand\headercell[1]{% for first row of table
   \smash[b]{\begin{tabular}[t]{@{}c@{}} #1 \end{tabular}}}

% Figures generated by DevFiles/maxima_with_graph_size.R
\title{Some consequences of the prior on relationships graphs}
\date{}
\author{}

\begin{document}
\maketitle

For a given recurrent state, we assume relationship graphs are uniformly distributed \textit{a priori}. This has various consequences discussed below. 

\tableofcontents

\section{Posterior bounds that are induced by the graph prior}

When the prior probability on relapse is non-zero, posterior probabilities of reinfection and recrudescence never reach one because genetic data compatible with either recrudescence or reinfection are also compatible with relapse. In this section we discuss bounds on posterior probabilities of reinfection and recrudescence; they are induced by the uniformity of the prior over relationship graphs. Bounds define a feasible set of posterior probabilities without any information about the genetic data beyond that used to derive the multiplicities of infection (MOIs). For example, in the case of two genotypes in an enrolment episode followed by a monoclonal recurrence, when recurrent states are equally likely \textit{a priori}, the posterior probabilities of reinfection and recrudescence are upper bounded by $\sfrac{9}{11}$ and $\sfrac{9}{13}$, respectively. The feasible set of posterior probabilities is shown in Figure~\ref{fig:feasible}.

\begin{SCfigure}
\includegraphics[width=0.5\textwidth]{figures/feasible.png}
\vspace{-2cm}
\caption{Feasible set of posterior probabilities in the case of two genotypes in the initial episode and one genotype in the recurrent episode. Dashed lines intersect the left and bottom edges of the simplex at $\frac{4}{13}$ and $\frac{2}{11}$, respectively.}\label{fig:feasible}
\end{SCfigure}

\subsection{How bounds are derived}

We start by making some observations about the posterior odds of relapse to reinfection / recrudescence; odds help simplify some derivations. 

\subsubsection{Single recurrence}

For clarity of exposition, we start with the case of a single recurrent episode. Let $\RG_\recru, \RG_\relap,$ and $\RG_\reinf$ denote subsets of the graph space $\RG$, containing the relationship graphs compatible with recrudescence, relapse, and reinfection respectively. The posterior odds of relapse to recrudescence is given by


\begin{equation*}
o_{\relap:\recru} \coloneqq 
\frac{\mathbb{P}(\bm{y} | \relap)\mathbb{P}(\relap)}{\mathbb{P}(\bm{y} | \recru)\mathbb{P}(\recru)} =
\frac{\mathbb{P}(\relap)}{\mathbb{P}(\recru)}
\frac{\sum_{\rg\in\RG_\relap}\mathbb{P}(\bm{y} | \rg)\mathbb{P}(\rg | \relap)}{\sum_{\rg\in\RG_\recru}\mathbb{P}(\bm{y} | \rg)\mathbb{P}(\rg | \recru)} =
\frac{\mathbb{P}(\relap)}{\mathbb{P}(\recru)}
\frac{| \RG_\recru |}{| \RG_\relap |} \frac{\sum_{\rg\in\RG_\relap}\mathbb{P}(\bm{y} | \rg)}{\sum_{\rg\in\RG_\recru}\mathbb{P}(\bm{y} | \rg)} = 
\frac{\mathbb{P}(\relap)}{\mathbb{P}(\recru)}
\frac{| \RG_\recru |}{| \RG_\relap |} \left(1 + \frac{\sum_{\rg\in\RG_\relap\setminus\RG_\recru}\mathbb{P}(\bm{y} | \rg)}{\sum_{\rg\in\RG_\recru}\mathbb{P}(\bm{y} | \rg)}\right), 
\end{equation*}


where $\RG_\relap\setminus\RG_\recru$ is the subset of graphs compatible with relapse but not recrudescence (graphs where genotypes from the recurrent episode are not all clones from the initial episode). It follows that $o_{\relap:\recru} \ge 
\sfrac{\mathbb{P}(\relap)| \RG_\recru |}
{\mathbb{P}(\recru)| \RG_\relap |}$. Note that this inequality is close to equality when $\sum_{\rg\in\RG_\relap\setminus\RG_\recru}\mathbb{P}(\bm{y} | \rg) \ll \sum_{\rg\in\RG_\recru}\mathbb{P}(\bm{y} | \rg)$.


Similarly, the posterior odds of relapse to reinfection is given by
\begin{equation*}
o_{\relap:\reinf} \coloneqq 
\frac{\mathbb{P}(\bm{y} | \relap)\mathbb{P}(\relap)}{\mathbb{P}(\bm{y} | \reinf)\mathbb{P}(\reinf)} = 
\frac{\mathbb{P}(\relap)}{\mathbb{P}(\reinf)}
\frac{| \RG_\reinf |}{| \RG_\relap |} \left(1 + \frac{\sum_{\rg\in\RG_\relap\setminus\RG_\reinf}\mathbb{P}(\bm{y} | \rg)}{\sum_{\rg\in\RG_\reinf}\mathbb{P}(\bm{y} | \rg)}\right).
\end{equation*}
It follows that $o_{\relap:\reinf} \ge 
\sfrac{\mathbb{P}(\relap)| \RG_\reinf |}
{\mathbb{P}(\reinf)| \RG_\relap |}$. Note that this inequality is close to equality when $\sum_{\rg\in\RG_\relap\setminus\RG_\reinf}\mathbb{P}(\bm{y} | \rg) \ll \sum_{\rg\in\RG_\reinf}\mathbb{P}(\bm{y} | \rg)$.

The posterior odds $o_{\reinf:\recru}$ can be defined similarly, but analogous lower bounds are not available. This is because $\RG_\recru$ and $\RG_\reinf$ do not intersect. Thus, we simply note that $o_{\reinf:\recru} \approx 0$ when $\mathbb{P}(\bm{y}|\reinf) \ll \mathbb{P}(\bm{y}\recru)$.

As for the posterior probabilities, we have
\begin{align} 
\mathbb{P}(\recru | \bm{y}) 
&= \frac{\mathbb{P}(\bm{y} | \recru)\mathbb{P}(\recru)}{\mathbb{P}(\bm{y} | \recru)\mathbb{P}(\recru)+\mathbb{P}(\bm{y} | \relap)\mathbb{P}(\relap)+\mathbb{P}(\bm{y} | \reinf)\mathbb{P}(\reinf)} \nonumber\\
&= \frac{1}{1+o_{\relap:\recru}+o_{\reinf:\recru}} \nonumber\\
&\le \dfrac{1}{1+\frac{\mathbb{P}(\relap)| \RG_\recru |} 
{\mathbb{P}(\recru)| \RG_\relap |}+0}
\nonumber\\
&= \dfrac{\mathbb{P}(\recru)}
{\mathbb{P}(\recru) + 
\mathbb{P}(\relap)\frac{|\RG_\recru|}{|\RG_\relap|}}.  \label{eq:recru_prob_max}
\end{align}
This inequality is close to equality when $\sum_{\rg\in\RG_\relap\setminus\RG_\recru}\mathbb{P}(\bm{y} | \rg) \ll \sum_{\rg\in\RG_\recru}\mathbb{P}(\bm{y} | \rg)$ and $\mathbb{P}(\bm{y}|\reinf) \ll \mathbb{P}(\bm{y}|\recru)$. Note that the former implies the latter as $\RG_\reinf \subseteq \RG_\relap\setminus\RG_\recru$. 

Similarly, we have
\begin{equation} 
\mathbb{P}(\reinf | \bm{y}) 
\le\dfrac{\mathbb{P}(\reinf)}
{\mathbb{P}(\reinf) + 
\mathbb{P}(\relap)\frac{|\RG_\reinf|}{|\RG_\relap|}}.  \label{eq:reinf_prob_max}
\end{equation}
Likewise, this inequality is close to equality when $\sum_{\rg\in\RG_\relap\setminus\RG_\reinf}\mathbb{P}(\bm{y} | \rg) \ll \sum_{\rg\in\RG_\reinf}\mathbb{P}(\bm{y} | \rg)$.

\subsubsection{More than one recurrence}

When there is more than one recurrence and prior probabilities are non-zero, the maximum probabilities of all sequences are non-certain with the exception of the relapse-only sequence. As before, we can compute odds; for example
\begin{align*}
o_{\relap\relap:\recru\relap} \coloneqq
\frac{\mathbb{P}(\bm{y} | \relap\relap)\mathbb{P}(\relap\relap)}{\mathbb{P}(\bm{y} | \recru\relap)\mathbb{P}(\recru\relap)} =
\frac{\mathbb{P}(\relap\relap)}{\mathbb{P}(\recru\relap)}
\frac{| \RG_{\recru\relap} |}{| \RG_{\relap\relap} |} \frac{\sum_{\rg\in\RG_{\relap\relap}}\mathbb{P}(\bm{y} | \rg)}{\sum_{\rg\in\RG_{\recru\relap}}\mathbb{P}(\bm{y} | \rg)} = 
\frac{\mathbb{P}(\relap\relap)}{\mathbb{P}(\recru\relap)}
\frac{| \RG_{\recru\relap} |}{| \RG_{\relap\relap} |} \left(1 + \frac{\sum_{\rg\in\RG_{\relap\relap}\setminus\RG_{\recru\relap}}\mathbb{P}(\bm{y} | \rg)}{\sum_{\rg\in\RG_{\recru\relap}}\mathbb{P}(\bm{y} | \rg)}\right).
\end{align*}
However, unlike before, we cannot always derive maximum posterior probabilities from the odds because the probabilities of the remaining sequences are not necessarily zero (the exception being when the odds of a all-but-one-relapse to all-relapse sequence are maximised). Instead, we must compute maximum probabilities the long way; for example,
\begin{align} 
    \mathbb{P}(\recru\recru | \bm{y}) = 
    &\left\{
    \sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\recru\recru)}{|\RG_{\recru\recru}|} 
    \right\} \left\{
    \sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\recru\recru)}{|\RG_{\recru\recru}|}  
    + \left(
    \sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) + 
    \smashoperator{\sum_{\rg\in\RG_{\relap\recru}\setminus\RG_{\recru\recru}}} 
    \mathbb{P}(\bm{y} | \rg)
    \right) \frac{\mathbb{P}(\relap\recru)}{|\RG_{\relap\recru}|}
    \right.  \nonumber \\ 
    + &\left. 
    \left(
    \sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) +
    \smashoperator{\sum_{\rg\in\RG_{\relap\relap}\setminus\RG_{\recru\recru}}}
    \mathbb{P}(\bm{y} | \rg) \right) \frac{\mathbb{P}(\relap\relap)}{|\RG_{\relap\relap}|} 
    + 
    \left(
    \sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) +
    \smashoperator{\sum_{\rg\in\RG_{\recru\relap}\setminus\RG_{\recru\recru}}}
    \mathbb{P}(\bm{y} | \rg) \right) \frac{\mathbb{P}(\recru\relap)}{|\RG_{\recru\relap}|}
    + \sum_{\rg\in\RG_{\recru\reinf}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\recru\reinf)}{|\RG_{\recru\reinf}|} +
    \right. \nonumber \\ 
    + &\left. 
    \sum_{\rg\in\RG_{\relap\reinf}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\relap\reinf)}{|\RG_{\relap\reinf}|} + 
    \sum_{\rg\in\RG_{\reinf\recru}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\reinf\recru)}{|\RG_{\reinf\recru}|} + 
    \sum_{\rg\in\RG_{\reinf\relap}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\reinf\relap)}{|\RG_{\reinf\relap}|} + 
    \sum_{\rg\in\RG_{\reinf\reinf}} \mathbb{P}(\bm{y} | \rg) 
    \sfrac{\mathbb{P}(\reinf\reinf)}{|\RG_{\reinf\reinf}|} 
    \right\}^{-1} \label{eq:CC_prob_max}
\end{align}
converges to 
\begin{equation*} 
\dfrac{
\mathbb{P}(\recru\recru)}{
\mathbb{P}(\recru\recru) + 
\mathbb{P}(\relap\recru)\frac{|\RG_{\recru\recru}|}{|\RG_{\relap\recru}|} + 
\mathbb{P}(\relap\relap)\frac{|\RG_{\recru\recru}|}{|\RG_{\relap\relap}|} + 
\mathbb{P}(\recru\relap)\frac{|\RG_{\recru\recru}|}{|\RG_{\recru\relap}|}}  
\end{equation*}
when $\sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg)$ significantly exceeds the summation over all other subsets of graph space in equation \eqref{eq:CC_prob_max}. 

Bounds on marginal posteriors are harder to compute because computation involves summation over sequences whose probabilities are not necessarily zero. For example, the bound on recrudescence at the first recurrence of two recurrences, is a maximum of three upper bounds each involving non-zero probabilities: 
\begin{enumerate}
    \item bound given maximal CC probability (probabilities of CI \& CL are not necessarily both zero) 
    \item bound given maximal CL probability (probabilities of CC \& CI are not necessarily both zero) 
    \item  bound given maximal CI probability (probabilities of CC \& CL are not necessarily both zero)
\end{enumerate}

\paragraph{Digression}
In the subsection ``Increasing episode counts'' of the vignette entitled ``Understand posterior estimates'' we compute maximum marginal probabilities of recrudescence / reinfection at the first recurrence of two / three recurrences. These maxima are not bounds imposed by the prior: they are based on additional knowledge that there are no recurrent data on all but the first recurrence. The computation only holds because all episodes are monoclonal. When all episodes are monoclonal, the likelihood of equivalent sequences (e.g., CC, CI and CL in the case of two recurrences with strong evidence of recrudescence on the first and no data on the second) are equal (otherwise, they are unequal for reasons analogous to those that explain departure from the prior in the section ``Data on only one episode'') and graph likelihoods are equal for all graphs compatible with equivalent sequences (e.g., $\mathbb{P}(\bm{y} | \rg)$ is the same $\forall \rg \in \RG_{\recru\recru}$, $\forall \rg \in \RG_{\recru\reinf}$, and $\forall \rg \in \RG_{\recru\relap}$ in the case of two recurrences with strong evidence of recrudescence on the first and no data on the second). Given a uniform prior on recurrent states, three monoclonal episodes with strong evidence of recrudescence for the first recurrence and no data on the second recurrence, we thus have 
\begin{align}
&\mathbb{P}(s_1 = \recru | \bm{y}  ) \\ 
&\leq 
    \dfrac{
    \sfrac{\sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) }{|\RG_{\recru\recru}|}}
    {
    \dfrac{\sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg)}{|\RG_{\recru\recru}|}  
    + 
    \dfrac{    \sum_{\rg\in\RG_{\recru\reinf}} \mathbb{P}(\bm{y} | \rg) }{|\RG_{\recru\reinf}|}  
    +  
    \dfrac{\sum_{\rg\in\RG_{\recru\relap}} \mathbb{P}(\bm{y} | \rg) }{|\RG_{\recru\relap}|}  
    +
    \dfrac{\sum_{\rg\in\RG_{\recru\recru}} \mathbb{P}(\bm{y} | \rg) }{|\RG_{\relap\recru}|} 
    +
    \dfrac{\sum_{\rg\in\RG_{\recru\reinf}} \mathbb{P}(\bm{y} | \rg)}{|\RG_{\relap\reinf}|} 
    +
    \dfrac{\sum_{\rg\in\RG_{\recru\relap}} \mathbb{P}(\bm{y} | \rg)}{|\RG_{\relap\relap}|}
  } \nonumber \\
   &=
    \dfrac{\sfrac{|\RG_{\recru\recru}|}{|\RG_{\recru\recru}|}}
    {
    \dfrac{|\RG_{\recru\recru}|}{|\RG_{\recru\recru}|}  
    + 
    \dfrac{|\RG_{\recru\reinf}|}{|\RG_{\recru\reinf}|}  
    +
    \dfrac{|\RG_{\recru\relap}|}{|\RG_{\recru\relap}|}  
    +
    \dfrac{|\RG_{\recru\recru}|}{|\RG_{\relap\recru}|}  
    +  
    \dfrac{|\RG_{\recru\reinf}|}{|\RG_{\relap\reinf}|}
    +   
    \dfrac{|\RG_{\recru\relap}|}{|\RG_{\relap\relap}|}
  } \nonumber \\
  &= \dfrac{1}
  {3 + \sfrac{1}{3} + \sfrac{1}{3} + \sfrac{3}{12}}. \label{eq:marginal_bound}
\end{align}
The same reasoning applies given strong evidence of reinfection. 



\section{Bounds as indicators of data informativeness}

By comparing probability estimates to their respective bounds, we might like to answer the question: could the posterior probability of my most probable state sequence be higher if I added data on more markers? However, we cannot guarantee convergence onto bounds. In the case of a marginal probability, the bound is the maximum of multiple upper bounds (see example above), and thus convergence is not guaranteed; in the case of a non-marginal probability, we suspect convergence might depend on the relationship graph from which the data are generated.  



\section{How bounds induced by the graph prior change with MOI}

In this section we explore how maximum probabilities of recrudescence / reinfection given a single recurrence change with graph size, where maximum probabilities are those induced by the the graph prior. Maximum probabilities of reinfection increase with the size of the graph, both when MOIs of the enrolment episode and the first recurrence are equal (plot \ref{fig:MOIDiff_reinfection}, centre) and not (plot \ref{fig:MOIDiff_reinfection}, off-centre). Maximum probabilities of recrudescence increase with graph size when the MOIs of the enrolment episode and the first recurrence are equal (plot \ref{fig:MOIDiff_recrudescence}, centre); they decrease with increasing disparity between the higher MOI of the enrolment episode and the lower MOI of the first recurrence (plot \ref{fig:MOIDiff_recrudescence}, right of centre). Note that, when the MOI of first recurrence exceeds that of the enrolment episode, recrudescence has zero posterior probability because we assume under the Pv3Rs model that all parasites are detected and that there are no genotyping errors; as such, a recrudescence can be at most as diverse as the preceding episode. 

\begin{figure}[h]
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=0.9\linewidth]
  {figures/maxima1.png}
  \caption{}
  \label{fig:MOIDiff_reinfection}
\end{subfigure}
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=0.9\linewidth]{figures/maxima2.png}
  \caption{}
  \label{fig:MOIDiff_recrudescence}
\end{subfigure}
\caption{Maximum probabilities of recrudescence / reinfection given a single recurrence.}
\label{fig:fig}
\end{figure}

\section{A counter-intuitive property}

% See DevFiles/GenerateDistributionOverEdge.R for graph counts featuring in eq 8 - 10

The \textit{a priori} assumption that all valid relationships graphs $\rg$ are equally likely given a recurrent state leads to a counter-intuitive property. Specifically, the probability of an edge can vary depending on the graph it is embedded within. Consider the scenario where one monoclonal recurrence follows a monoclonal enrolment episode. 

Because we assume that the three relationship graphs are equally likely given relapse, the probability distribution of the edge between the two genotypes given relapse is
\begin{align}
    \mathbb{P}(\text{the two genotypes are clones}\vert\bm{s}=\relap) &= \sfrac{1}{3},
    \label{eq: 1st two C gvn L}\\
    \mathbb{P}(\text{the two genotypes are siblings}\vert\bm{s}=\relap) &= \sfrac{1}{3},\\
    \mathbb{P}(\text{the two genotypes are strangers}\vert\bm{s}=\relap) &= \sfrac{1}{3}. 
\end{align}
Now consider the scenario in which there is an additional monoclonal recurrence. 

There are now 12 relationship graphs, which are assumed to be equally likely under relapses. Among them, between the first two genotypes, three have a clonal edge, four have a sibling edge, and five have a stranger edge. The probability distribution of the edge between the first two genotypes given relapses is thus
\begin{align}
    \mathbb{P}(\text{the first two genotypes are clones}\vert\bm{s}=\relap\relap) &= \sfrac{3}{12},
    \label{eq: 1st two C gvn LL}\\
    \mathbb{P}(\text{the first two genotypes are siblings}\vert\bm{s}=\relap\relap) &= \sfrac{4}{12},\\
    \mathbb{P}(\text{the first two genotypes are strangers}\vert\bm{s}=\relap\relap) &= \sfrac{5}{12}.
\end{align}

An explanation for the change in the probability distribution of the edge between the first two genotypes upon the addition of the second relapse is that a clonal edge between the first two genotypes imposes a constraint where the two remaining edges must exhibit the same relationship. Similarly, a sibling edge between the first two genotypes is incompatible with a single stranger edge among the two remaining edges. In general, the pattern that stranger edges are more likely \textit{a priori} and clonal edges are less likely \textit{a priori} becomes more prominent when more genotypes are present. For monoclonal episodes, this change in distribution over the edge between the first two genotypes results in an increase / decrease in the maximum probability that the first recurrence is a recrudescence / reinfection with the addition of monoclonal recurrences devoid of data (Figure \ref{fig:monoclonal_recurrences}), where the maximum probabilities are those assuming all episodes are monoclonal and there are no recurrent data on all but the first recurrence (e.g., as in equation \eqref{eq:marginal_bound}). 

\begin{SCfigure}
    \centering
    \includegraphics[width=0.6\linewidth]{figures/maxima3.png}
    \caption{The probability that the first recurrence is a recrudescence / reinfection increases / decreases with additional recurrences devoid of data. The prior on recurrent states is uniform. The maximum probabilities are those based on knowledge that there are no recurrent data for all but the first recurrence and all episodes are monoclonal. For example, from equations \eqref{eq: 1st two C gvn L} and \eqref{eq: 1st two C gvn LL} we have $\sfrac{|\RG_\recru|}{|\RG_\relap|} = \sfrac{1}{3} > \sfrac{|\RG_{\recru\relap}|}{|\RG_{\relap\relap}|} = \sfrac{3}{12}$. Plugging $\sfrac{|\RG_\recru|}{|\RG_\relap|} = \sfrac{1}{3}$ into equation \eqref{eq:recru_prob_max}, and $\sfrac{|\RG_{\recru\relap}|}{|\RG_{\relap\relap}|} = \sfrac{3}{12}$ plus $\sfrac{|\RG_{\recru\recru}|}{|\RG_{\relap\recru}|} = \sfrac{1}{3}$ and $\sfrac{|\RG_{\recru\reinf}|}{|\RG_{\relap\reinf}|} = \sfrac{1}{3}$ into equation \eqref{eq:marginal_bound}, we see that the probability that the first recurrence is a recrudescence when recurrent states are equally likely \textit{a priori} increases slightly from $\sfrac{3}{4}$ to $\sfrac{3}{\left(3 + \sfrac{11}{12}\right)}$ with the addition of the second recurrence without data.}
    \label{fig:monoclonal_recurrences}
\end{SCfigure}

\end{document}